var express = require('express');
var router = express.Router();
var db = require('../db');
var nodemailer = require("nodemailer");
var smtpTransport = nodemailer.createTransport({
  service: 'Gmail',
  auth: {
    user: 'study.simpleSNS@gmail.com',
    pass: 'simple123SNS'
  }
});

router.get('/send', function(req, res, next) {
	console.log('/send');
  var email = decodeURI(req.query.to);
	console.log(email);
  var rand = Math.floor((Math.random() * 9000 + 1000));
  var link="http://"+req.get("host")+"/email/verify?email="+email+"&num="+rand;
  var mailOptions={
		to : email,
    subject : "Please confirm your Email account",
    html : "Hello,<br> Please Click on the link to verify your email.<br><a href="+link+">Click here to verify</a>" 
  }

	try{
  	smtpTransport.sendMail(mailOptions, function(error, response){
    	if(error){
      	console.log(error);
      	res.json({result:false,message:"Incorrect email", code:404});
    	}else{
				console.log(JSON.stringify(response, null, 2));
//     		console.log("Message sent: " + response.message);
				try{
					console.log(JSON.stringify(db, null, 2));
					//db.get().dbHelper.emailRequest(email,rand);
					var sql = "INSERT INTO email_verification(email, code) VALUES(?,?)";
					var input = [email, rand];
					
					db.get().query(sql, input, function(err, result){
						if(err) res.json({result:false, message:"SQL error", code:403});
						res.json({result:true, message:"Please check your email.", code:100});
					});
					
//					res.json({result:false, message:"DB ERROR", code:401});
				}catch(e){
					console.log(e);
				}
    	}
  	});
	}catch(e){
		console.log(e);
	}
});

router.get('/verify',async function(req,res){
	console.log('/verify');
  var result = await dbHelper.verify(req.query.email,req.query.num);
  if(result==true){
    console.log("email is verified");
    db.get().dbHelper.verifyUpdate(req.query.email,req.query.num);
    res.json({result:true, code:100, message:"Checked your email successfully."});
  } else  {
      console.log("email is not verified");
      res.json({result:false, code:401, message:"email is not verified"});
  }
});

router.post('/register',async function(req,res){
	console.log('/register');
	var email = req.body.email;
	var password = req.body.password;
	var username = req.body.username;

    if(email==undefined||password==undefined||username==undefined){
        res.json({result:false,code:401, message:"undefined parameter"});
    } else {
        var result = await dbHelper.emailRegister(req.body.email,req.body.pass,req.body.nick,req.body.devid);
        res.json(result);
    }
});

router.post('/login',async function(req,res){
	console.log('/login');
	var email = req.body.email;
	var password = req.body.password;
    if(email==undefined||password==undefined){
        res.json({result:false,code:401, message:"undefined parameter"});
    } else {
        var result = await dbHelper.emailLogin(req.body.email,req.body.pass,req.body.devid);
        res.json(result);
    }
});

module.exports = router;
